name: Bank Frontend Pipeline

on:
  push:
    branches:
      - main

jobs:
  Continues-Integration_build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout frontend repo
        uses: actions/checkout@v4
        with:
          repository: pod-2-cohort-4/frontend-repo
          ref: main

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Build container image
        run: docker build -t bank-app-frontend:latest .

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region us-east-1 \
          | docker login --username AWS --password-stdin ${{ vars.ECR_REPO }}

      - name: Tag and push image
        run: |
          docker tag bank-app-frontend:latest \
            ${{ vars.ECR_REPO }}/bank-frontend:${{ github.run_number }}
          docker push \
            ${{ vars.ECR_REPO }}/bank-frontend:${{ github.run_number }}

  Continues-Update_k8s_manifest:
    runs-on: ubuntu-latest
    needs: Continues-Integration_build_and_push
    permissions:
      contents: write  # Required to push changes to repo

    steps:
      - name: Checkout Kubernetes manifest repo
        uses: actions/checkout@v4
        with:
          repository: pod-2-cohort-4/Kubernetes-manifest
          token: ${{ secrets.K8S_REPO_TOKEN }}
          path: Kubernetes-manifest
          fetch-depth: 1

      - name: Update image tag and push
        run: |
          cd Kubernetes-manifest

          # Configure Git
          git config user.email "ibehfavourbenson@gmail.com"
          git config user.name "Favour-ibe"

          # Update frontend image tag in the manifest
          sed -i "s+${{ vars.ECR_REPO }}/bank-frontend:.*+${{ vars.ECR_REPO }}/bank-frontend:${{ github.run_number }}+g" \
            bank-project/frontend.yaml

          # Verify the update safely
          if grep -q "${{ vars.ECR_REPO }}/bank-frontend:${{ github.run_number }}" bank-project/frontend.yaml; then
            echo "Image tag updated successfully!"
          else
            echo "Warning: Image tag not found in manifest"
          fi

          # Commit and push only if there are changes
          if git diff --quiet bank-project/frontend.yaml; then
            echo "No changes detected, skipping commit."
          else
            git add bank-project/frontend.yaml
            git commit -m "Update frontend image to version ${{ github.run_number }}"
            git push origin main
          fi



 
